{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://awpl.spice/schema/v1",
  "title": "AWPL Schema",
  "description": "JSON Schema for validating Abstract Workflow Pipeline Language (AWPL) applications",
  "type": "object",
  "required": ["name", "runtime", "config"],
  "properties": {
    "name": {
      "type": "string",
      "description": "Unique name of the application",
      "minLength": 1
    },
    "description": {
      "type": "string",
      "description": "Optional description providing context about the application."
    },
    "runtime": {
      "type": "string",
      "description": "Execution environment",
      "enum": ["airflow", "flink"]
    },
    "config": {
      "type": "object",
      "description": "Application-specific configuration",
      "properties": {
        "runtime": {
          "type": "object",
          "description": "Runtime-specific configuration"
        }
      },
      "required": ["runtime"],
      "allOf": [
        {
          "if": {
            "properties": {
              "runtime": {
                "const": "airflow"
              }
            }
          },
          "then": {
            "properties": {
              "runtime": {
                "$ref": "#/definitions/airflowConfig"
              }
            }
          }
        }
      ]
    },
    "nodes": {
      "type": "array",
      "description": "List of nodes (tasks, branches, loops, maps)",
      "default": [],
      "items": {
        "$ref": "#/definitions/node"
      }
    }
  },
  "definitions": {
    "node": {
      "type": "object",
      "oneOf": [
        {
          "$ref": "#/definitions/taskNode"
        },
        {
          "$ref": "#/definitions/branchNode"
        },
        {
          "$ref": "#/definitions/loopNode"
        },
        {
          "$ref": "#/definitions/mapNode"
        }
      ]
    },
    "taskNode": {
      "type": "object",
      "required": ["task"],
      "properties": {
        "task": {
          "type": "object",
          "required": ["id", "task_config"],
          "properties": {
            "id": {
              "type": "string",
              "description": "Unique identifier",
              "minLength": 1
            },
            "description": {
              "type": "string",
              "description": "Optional description"
            },
            "depends_on": {
              "type": "array",
              "description": "List of task/node IDs this depends on",
              "default": [],
              "items": {
                "type": "string"
              }
            },
            "task_config": {
              "type": "object",
              "description": "Task-specific configuration",
              "properties": {
                "kubernetes_pod_operator": {
                  "$ref": "#/definitions/kubernetesPodOperator"
                }
              }
            },
            "resource_hints": {
              "$ref": "#/definitions/resourceHints"
            },
            "slo": {
              "description": "Service-level objectives"
            }
          }
        }
      }
    },
    "branchNode": {
      "type": "object",
      "required": ["branch"],
      "properties": {
        "branch": {
          "type": "object",
          "required": ["id", "conditions", "branches"],
          "properties": {
            "id": {
              "type": "string",
              "description": "Unique identifier",
              "minLength": 1
            },
            "description": {
              "type": "string",
              "description": "Optional description"
            },
            "depends_on": {
              "type": "array",
              "description": "List of task/node IDs this depends on",
              "default": [],
              "items": {
                "type": "string"
              }
            },
            "conditions": {
              "type": "array",
              "description": "List of condition objects",
              "minItems": 1,
              "items": {
                "$ref": "#/definitions/condition"
              }
            },
            "branches": {
              "type": "object",
              "required": ["true"],
              "properties": {
                "true": {
                  "type": "array",
                  "description": "Nodes to execute if condition is true",
                  "items": {
                    "$ref": "#/definitions/node"
                  }
                },
                "false": {
                  "type": "array",
                  "description": "Nodes to execute if condition is false",
                  "default": [],
                  "items": {
                    "$ref": "#/definitions/node"
                  }
                }
              }
            }
          }
        }
      }
    },
    "loopNode": {
      "type": "object",
      "required": ["loop"],
      "properties": {
        "loop": {
          "type": "object",
          "required": ["id", "conditions", "body"],
          "properties": {
            "id": {
              "type": "string",
              "description": "Unique identifier",
              "minLength": 1
            },
            "description": {
              "type": "string",
              "description": "Optional description"
            },
            "depends_on": {
              "type": "array",
              "description": "List of task/node IDs this depends on",
              "default": [],
              "items": {
                "type": "string"
              }
            },
            "loop_data": {
              "type": "object",
              "description": "Defines loop variable tracking",
              "required": ["id", "init", "loop"],
              "properties": {
                "id": {
                  "type": "string",
                  "description": "Identifier for loop variable",
                  "minLength": 1
                },
                "init": {
                  "type": "string",
                  "description": "Reference to task/value for initialization",
                  "pattern": "^\\$[a-zA-Z_][a-zA-Z0-9_]*(\\.[a-zA-Z_][a-zA-Z0-9_]*)*$|^[^$].*$"
                },
                "loop": {
                  "type": "string",
                  "description": "Reference to task that updates the variable",
                  "pattern": "^\\$[a-zA-Z_][a-zA-Z0-9_]*(\\.[a-zA-Z_][a-zA-Z0-9_]*)*$"
                }
              }
            },
            "conditions": {
              "type": "array",
              "description": "Conditions for loop termination",
              "minItems": 1,
              "items": {
                "$ref": "#/definitions/condition"
              }
            },
            "body": {
              "type": "array",
              "description": "Nodes executed in each iteration",
              "minItems": 1,
              "items": {
                "$ref": "#/definitions/node"
              }
            }
          }
        }
      }
    },
    "mapNode": {
      "type": "object",
      "required": ["map"],
      "properties": {
        "map": {
          "type": "object",
          "required": ["id", "items", "body"],
          "properties": {
            "id": {
              "type": "string",
              "description": "Unique identifier",
              "minLength": 1
            },
            "depends_on": {
              "type": "array",
              "description": "List of task/node IDs this depends on",
              "default": [],
              "items": {
                "type": "string"
              }
            },
            "items": {
              "description": "Literal list or task reference returning a list",
              "oneOf": [
                {
                  "type": "string",
                  "pattern": "^\\$[a-zA-Z_][a-zA-Z0-9_]*(\\.[a-zA-Z_][a-zA-Z0-9_]*)*$"
                },
                {
                  "type": "array"
                }
              ]
            },
            "body": {
              "type": "array",
              "description": "Nodes executed for each list element",
              "minItems": 1,
              "items": {
                "$ref": "#/definitions/node"
              }
            }
          }
        }
      }
    },
    "condition": {
      "type": "object",
      "required": ["lhs", "rhs", "operator"],
      "properties": {
        "lhs": {
          "type": "string",
          "description": "Left-hand side (literal or task reference)"
        },
        "rhs": {
          "type": "string",
          "description": "Right-hand side (literal or task reference)"
        },
        "operator": {
          "type": "string",
          "description": "Comparison operator",
          "enum": [">", "<", ">=", "<=", "==", "equals"]
        },
        "negation": {
          "type": "boolean",
          "description": "Whether to negate the condition",
          "default": false
        },
        "combinedWith": {
          "type": "string",
          "description": "Logical operator for combining with next condition",
          "enum": ["and", "or"],
          "default": "and"
        }
      }
    },
    "resourceHints": {
      "type": "array",
      "description": "List of resource hint objects",
      "items": {
        "type": "object",
        "required": ["type"],
        "properties": {
          "type": {
            "type": "string",
            "description": "Resource type",
            "enum": ["cpu", "memory", "gpu", "storage"]
          },
          "min": {
            "type": "string",
            "description": "Minimum resource amount",
            "default": "0"
          },
          "max": {
            "type": "string",
            "description": "Maximum resource amount"
          }
        }
      }
    },
    "airflowConfig": {
      "type": "object",
      "required": ["schedule"],
      "properties": {
        "schedule": {
          "type": "string",
          "description": "Cron-style schedule"
        },
        "catchup": {
          "type": "boolean",
          "description": "Whether to catch up on missed runs",
          "default": false
        },
        "tags": {
          "type": "array",
          "description": "Metadata tags",
          "default": [],
          "items": {
            "type": "string"
          }
        },
        "default_args": {
          "type": "object",
          "description": "Default arguments",
          "default": {},
          "properties": {
            "owner": {
              "type": "string",
              "description": "Pipeline owner identifier",
              "default": ""
            },
            "retries": {
              "type": "integer",
              "description": "Number of retry attempts",
              "minimum": 0,
              "default": 0
            },
            "retry_delay": {
              "type": "string",
              "description": "Delay between retries (e.g., '5m')",
              "default": "0m"
            },
            "start_date": {
              "type": "string",
              "description": "Start time (ISO 8601 format)"
            },
            "end_date": {
              "type": "string",
              "description": "End time (ISO 8601 format)"
            }
          }
        },
        "is_paused_upon_creation": {
          "type": "boolean",
          "description": "Whether DAG is paused initially",
          "default": false
        }
      }
    },
    "kubernetesPodOperator": {
      "type": "object",
      "required": ["name", "image"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Pod name",
          "minLength": 1
        },
        "do_xcom_push": {
          "type": "boolean",
          "description": "Whether to push XComs",
          "default": true
        },
        "namespace": {
          "type": "string",
          "description": "Kubernetes namespace",
          "default": "default"
        },
        "image": {
          "type": "string",
          "description": "Docker image",
          "minLength": 1
        },
        "cmds": {
          "type": "array",
          "description": "Commands to execute",
          "default": [],
          "items": {
            "type": "string"
          }
        },
        "arguments": {
          "type": "array",
          "description": "Container entrypoint arguments",
          "default": [],
          "items": {
            "type": "string"
          }
        },
        "volumes": {
          "type": "array",
          "description": "Volumes",
          "default": [],
          "items": {
            "type": "object",
            "required": ["name", "claim_name"],
            "properties": {
              "name": {
                "type": "string"
              },
              "claim_name": {
                "type": "string"
              }
            }
          }
        },
        "volume_mounts": {
          "type": "array",
          "description": "Volume mounts",
          "default": [],
          "items": {
            "type": "object",
            "required": ["name", "mount_path"],
            "properties": {
              "name": {
                "type": "string"
              },
              "mount_path": {
                "type": "string"
              }
            }
          }
        },
        "env_vars": {
          "type": "array",
          "description": "Environment variables",
          "default": [],
          "items": {
            "type": "object",
            "required": ["name", "value"],
            "properties": {
              "name": {
                "type": "string"
              },
              "value": {
                "type": "string"
              }
            }
          }
        },
        "image_pull_policy": {
          "type": "string",
          "description": "Image pull policy",
          "enum": ["Always", "IfNotPresent", "Never"],
          "default": "Always"
        },
        "config_file": {
          "type": "string",
          "description": "Kubernetes config file path",
          "default": "~/.kube/config"
        },
        "hostnetwork": {
          "type": "boolean",
          "description": "Use host network",
          "default": false
        },
        "skip_on_exit_code": {
          "type": "number",
          "description": "Exit code to treat as skipped"
        }
      }
    }
  }
}
